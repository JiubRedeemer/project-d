# =============================================================================
# CI/CD — Build and deploy on remote server (Docker only, no Ansible)
# =============================================================================
# Builds and runs all services from deploy/docker-compose.yml on the deploy host.
# Requires: DEPLOY_HOST, DEPLOY_USER, DEPLOY_SSH_KEY; optional env vars in secrets.
# =============================================================================

name: Deploy Project-D

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

concurrency:
  group: deploy-project-d
  cancel-in-progress: false

permissions:
  contents: read

env:
  DEPLOY_PATH: "/root/project-d-auto"
  DEPLOY_SUBDIR: "project-d-gateway"

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
      DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
      DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
      UI_DOMAIN: ${{ secrets.UI_DOMAIN }}
      LETSENCRYPT_EMAIL: ${{ secrets.LETSENCRYPT_EMAIL }}
      DB_USERNAME: ${{ secrets.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      MINIO_ACCESS_KEY: ${{ secrets.MINIO_ACCESS_KEY }}
      MINIO_SECRET_KEY: ${{ secrets.MINIO_SECRET_KEY }}
      JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
      CORS_ALLOWED_URLS: ${{ secrets.CORS_ALLOWED_URLS }}
      SERVER_HOST: ${{ secrets.SERVER_HOST }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate deploy secrets
        run: |
          missing=
          [ -z "$DEPLOY_HOST" ]  && missing="$missing DEPLOY_HOST"
          [ -z "$DEPLOY_USER" ]  && missing="$missing DEPLOY_USER"
          [ -z "$DEPLOY_SSH_KEY" ] && missing="$missing DEPLOY_SSH_KEY"
          if [ -n "$missing" ]; then
            echo "::error::Missing required GitHub secrets (Settings → Secrets and variables → Actions):$missing"
            echo "Add these repository secrets and re-run the workflow."
            exit 1
          fi
          echo "Required secrets are set."

      - name: Create .env for deploy
        run: |
          {
            echo "SERVER_HOST=${SERVER_HOST:-localhost}"
            echo "UI_DOMAIN=${UI_DOMAIN}"
            echo "LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL}"
            echo "UI_PORT=${UI_PORT:-80}"
            echo "GATEWAY_PORT=${GATEWAY_PORT:-8080}"
            echo "FILESTORAGE_PORT=${FILESTORAGE_PORT:-8079}"
            echo "MINIO_CONSOLE_PORT=${MINIO_CONSOLE_PORT:-9001}"
            echo "DB_USERNAME=${DB_USERNAME:-pd}"
            echo "DB_PASSWORD=${DB_PASSWORD:-pd}"
            echo "MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-minioadmin}"
            echo "MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-minioadmin}"
            echo "JWT_SECRET_KEY=${JWT_SECRET_KEY}"
            echo "CORS_ALLOWED_URLS=${CORS_ALLOWED_URLS:-http://localhost,http://localhost:80}"
          } > deploy/.env
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          UI_DOMAIN: ${{ secrets.UI_DOMAIN }}
          LETSENCRYPT_EMAIL: ${{ secrets.LETSENCRYPT_EMAIL }}
          UI_PORT: ${{ secrets.UI_PORT }}
          GATEWAY_PORT: ${{ secrets.GATEWAY_PORT }}
          FILESTORAGE_PORT: ${{ secrets.FILESTORAGE_PORT }}
          MINIO_CONSOLE_PORT: ${{ secrets.MINIO_CONSOLE_PORT }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          MINIO_ACCESS_KEY: ${{ secrets.MINIO_ACCESS_KEY }}
          MINIO_SECRET_KEY: ${{ secrets.MINIO_SECRET_KEY }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          CORS_ALLOWED_URLS: ${{ secrets.CORS_ALLOWED_URLS }}

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # Restore newlines if the secret was pasted with literal \n (e.g. from JSON/script)
          echo "$DEPLOY_SSH_KEY" | sed 's/\\n/\n/g' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # Verify key is valid and show fingerprint (so you can confirm it matches server)
          ssh-keygen -y -f ~/.ssh/id_rsa > /dev/null || { echo "::error::DEPLOY_SSH_KEY is not a valid private key. Paste the full key including -----BEGIN ... KEY----- and -----END ... KEY----- lines."; exit 1; }
          echo "SSH key fingerprint: $(ssh-keygen -l -f ~/.ssh/id_rsa | awk '{print $2}')"
          ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Test SSH connection
        run: |
          if ! ssh -o BatchMode=yes -o ConnectTimeout=15 "$DEPLOY_USER@$DEPLOY_HOST" "echo OK"; then
            echo "::error::SSH authentication failed. Check:"
            echo "  1. DEPLOY_SSH_KEY is the *private* key (starts with -----BEGIN ... PRIVATE KEY-----)."
            echo "  2. The matching *public* key is in the server's ~/.ssh/authorized_keys for user $DEPLOY_USER."
            echo "  3. If you pasted the key in one line, use a secret with real newlines or literal \\n between lines."
            echo "  Key fingerprint used by this job: $(ssh-keygen -l -f ~/.ssh/id_rsa | awk '{print $2}')"
            exit 1
          fi

      - name: Install rsync
        run: sudo apt-get update && sudo apt-get install -y rsync openssh-client

      - name: Sync repository to remote server
        run: |
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='**/node_modules' \
            --exclude='**/target' \
            --exclude='minioFiles' \
            --exclude='.idea' \
            --exclude='*.iml' \
            --exclude='.DS_Store' \
            -e "ssh -o StrictHostKeyChecking=accept-new" \
            . "$DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/$DEPLOY_SUBDIR/"

      - name: Verify deploy files on server
        run: |
          ssh "$DEPLOY_USER@$DEPLOY_HOST" "ls -la $DEPLOY_PATH/$DEPLOY_SUBDIR/deploy/ || true"

      - name: Build and deploy with Docker Compose
        run: |
          COMPOSE_FILE="$DEPLOY_PATH/$DEPLOY_SUBDIR/deploy/docker-compose.yml"
          ssh "$DEPLOY_USER@$DEPLOY_HOST" "docker compose -f $COMPOSE_FILE build && docker compose -f $COMPOSE_FILE up -d"
